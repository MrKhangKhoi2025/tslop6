<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picaball - Qu·∫£n l√Ω s√¢n b√≥ng</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --hover-color: #45a049;
            --background-color: #f4f4f4;
            --text-color: #333;
            --card-bg: white;
        }

        .confirmation-modal,
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(-20px);
            opacity: 0;
            animation: slideUp 0.3s ease forwards;
        }

        .password-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .modal-message {
            font-size: 1.1em;
            margin-bottom: 25px;
            color: #555;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .confirm-btn {
            background: var(--primary-color);
            color: white;
        }

        .confirm-btn:hover {
            background: var(--hover-color);
        }

        .cancel-btn {
            background: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .stadiums-container {
            display: grid;
            gap: 25px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .stadium-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
        }

        .stadium-card:hover {
            transform: translateY(-3px);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #666;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .button {
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
        }

        .button-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .button-primary:hover {
            background-color: var(--hover-color);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .status-indicator {
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            margin: 20px 0;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-available {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-busy {
            background-color: #ffebee;
            color: #c62828;
        }

        .time-display {
            font-size: 18px;
            font-weight: 500;
            color: #666;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }

        .result-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.95em;
        }

        .global-notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .success { background: #4CAF50; }
        .error { background: #f44336; }

        @media (max-width: 768px) {
            .stadiums-container {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0 15px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-message" id="modalMessage"></div>
            <div class="modal-buttons">
                <button class="modal-button confirm-btn" id="confirmAction">X√°c nh·∫≠n</button>
                <button class="modal-button cancel-btn" id="cancelAction">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="password-modal" id="passwordModal">
        <div class="password-content">
            <h3 style="margin:0 0 15px;color:#333;">X√ÅC TH·ª∞C QU·∫¢N TR·ªä</h3>
            <input type="password" 
                   class="password-input" 
                   id="passwordInput" 
                   placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                   autocomplete="current-password">
            <div class="modal-buttons">
                <button class="modal-button confirm-btn" id="submitPassword">X√°c nh·∫≠n</button>
                <button class="modal-button cancel-btn" id="cancelPassword">H·ªßy</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üïπÔ∏è PICABALL - H·ªÜ TH·ªêNG T√çNH TI·ªÄN</h1>
        <div class="stadiums-container" id="stadiumsContainer"></div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwnTg6jRGUaJZeIHUQbzBbsZ3TBh9_msNg23JkUoCYJmIfH9XlCqy1LCLS7Lb2Bre7CXQ/exec";
        const VALID_PASSWORDS = ["tan123", "hue123", "ha123"];
        const STADIUMS = [
            { id: 1, name: "S√¢n 1", defaultRate: 80000 },
            { id: 2, name: "S√¢n 2", defaultRate: 80000 },
            { id: 3, name: "S√¢n 3", defaultRate: 80000 }
        ];

        class StadiumManager {
            constructor(stadiums) {
                this.stadiums = stadiums;
                this.timers = {};
                this.pendingAction = null;
                this.init();
            }

            init() {
                this.renderStadiums();
                this.restoreSessions();
                this.setupEventListeners();
                this.setupModalHandlers();
                this.setupPasswordHandlers();
                this.startStatusPolling();
            }

            startStatusPolling() {
                setInterval(() => this.fetchAllStatuses(), 3000);
            }

            async fetchAllStatuses() {
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=getStatus`);
                    const statuses = await response.json();
                    statuses.forEach(status => {
                        this.updateUI(status.stadiumId, status.status.toLowerCase());
                    });
                } catch (error) {
                    console.error('L·ªói t·∫£i tr·∫°ng th√°i:', error);
                }
            }

            setupModalHandlers() {
                const modal = document.getElementById('confirmationModal');
                document.getElementById('confirmAction').addEventListener('click', () => {
                    modal.style.display = 'none';
                    this.pendingAction?.action();
                });

                document.getElementById('cancelAction').addEventListener('click', () => {
                    modal.style.display = 'none';
                    this.pendingAction = null;
                });
            }

            setupPasswordHandlers() {
                const passwordModal = document.getElementById('passwordModal');
                document.getElementById('submitPassword').addEventListener('click', () => {
                    const input = document.getElementById('passwordInput').value;
                    if(VALID_PASSWORDS.includes(input)) {
                        passwordModal.style.display = 'none';
                        this.pendingAction?.();
                    } else {
                        this.showNotification('‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', 'error');
                        passwordModal.style.display = 'none';
                    }
                });

                document.getElementById('cancelPassword').addEventListener('click', () => {
                    passwordModal.style.display = 'none';
                });

                document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') document.getElementById('submitPassword').click();
                });
            }

            showConfirmation(message, action) {
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('confirmationModal').style.display = 'flex';
                this.pendingAction = { action };
            }

            showPasswordModal(action) {
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordModal').style.display = 'flex';
                this.pendingAction = action;
            }

            async handleStartSession(stadiumId) {
                this.showConfirmation('B·∫ÆT ƒê·∫¶U t√≠nh gi·ªù cho s√¢n n√†y?', () => {
                    this.showPasswordModal(async () => {
                        const startTime = new Date();
                        localStorage.setItem(`stadium_${stadiumId}`, JSON.stringify({
                            startTime: startTime.toISOString(),
                            rate: this.getInputValue(stadiumId, '.rate-input'),
                            status: 'busy'
                        }));
                        await this.updateServerStatus(stadiumId, 'busy');
                        this.updateUI(stadiumId, 'busy');
                        this.startTimer(stadiumId, startTime);
                        this.showNotification('üü¢ ƒê√£ b·∫Øt ƒë·∫ßu t√≠nh gi·ªù!', 'success');
                    });
                });
            }

            async handleCalculate(stadiumId) {
                this.showConfirmation('T√çNH TI·ªÄN v√† k·∫øt th√∫c phi√™n?', () => {
                    this.showPasswordModal(async () => {
                        try {
                            const session = JSON.parse(localStorage.getItem(`stadium_${stadiumId}`));
                            if (!session) throw new Error('Kh√¥ng t√¨m th·∫•y phi√™n');

                            const endTime = new Date();
                            const timeDiff = endTime - new Date(session.startTime);
                            
                            const totalCost = this.calculateTotalCost(stadiumId, timeDiff, session.rate);
                            this.displayResult(stadiumId, totalCost);
                            
                            await this.sendToGoogleSheets({
                                stadiumId,
                                startTime: session.startTime,
                                endTime: endTime.toISOString(),
                                ...this.getProductData(stadiumId),
                                totalCost: totalCost.totalCost
                            });

                            localStorage.removeItem(`stadium_${stadiumId}`);
                            await this.updateServerStatus(stadiumId, 'available');
                            this.updateUI(stadiumId, 'available');
                            clearInterval(this.timers[stadiumId]);
                            this.showNotification('‚úÖ ƒê√£ l∆∞u d·ªØ li·ªáu!', 'success');

                        } catch (error) {
                            this.showNotification(`‚ùå L·ªói: ${error.message}`, 'error');
                        }
                    });
                });
            }

            renderStadiums() {
                const container = document.getElementById('stadiumsContainer');
                container.innerHTML = this.stadiums.map(stadium => `
                    <div class="stadium-card" data-stadium-id="${stadium.id}">
                        <h2>${stadium.name}</h2>
                        <div class="time-display" id="timer${stadium.id}">üïí 00:00:00</div>
                        <div class="input-group">
                            <label class="input-label">üíµ Gi√°/gi·ªù (VND):</label>
                            <input type="number" 
                                   class="input-field rate-input" 
                                   value="${stadium.defaultRate}" 
                                   min="0" 
                                   step="1000">
                        </div>
                        ${this.renderProductInput('üíß N∆∞·ªõc su·ªëi', 'water', 5000)}
                        ${this.renderProductInput('ü•§ B√π kho√°ng', 'mineral', 10000)}
                        ${this.renderProductInput('‚öΩ B√≥ng', 'ball', 50000)}
                        <div class="button-group">
                            <button class="button button-primary start-btn">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu</button>
                            <button class="button button-primary calculate-btn" style="display:none;">üßÆ T√≠nh ti·ªÅn</button>
                        </div>
                        <div class="status-indicator status-available" id="status${stadium.id}">üü¢ Tr·ªëng</div>
                        <div class="result-box" id="result${stadium.id}"></div>
                    </div>
                `).join('');
            }

            renderProductInput(label, prefix, price) {
                return `
                    <div class="input-group">
                        <label class="input-label">${label}:</label>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <input type="number" class="input-field ${prefix}-quantity" placeholder="S·ªë l∆∞·ª£ng" min="0">
                            <input type="number" class="input-field ${prefix}-price" value="${price}" min="0" step="1000">
                        </div>
                    </div>
                `;
            }

            setupEventListeners() {
                document.getElementById('stadiumsContainer').addEventListener('click', (e) => {
                    const stadiumCard = e.target.closest('.stadium-card');
                    if (!stadiumCard) return;
                    const stadiumId = parseInt(stadiumCard.dataset.stadiumId);
                    
                    if (e.target.classList.contains('start-btn')) this.handleStartSession(stadiumId);
                    if (e.target.classList.contains('calculate-btn')) this.handleCalculate(stadiumId);
                });

                document.querySelectorAll('.input-field').forEach(input => {
                    input.addEventListener('input', () => this.validateInput(input));
                });
            }

            validateInput(input) {
                if (parseInt(input.value) < 0) input.value = 0;
            }

            calculateTotalCost(stadiumId, timeDiff, rate) {
                const hours = (timeDiff / 3600000).toFixed(2);
                const stadiumCost = Math.round(hours * rate);
                const products = {
                    water: this.getProductValues(stadiumId, 'water'),
                    mineral: this.getProductValues(stadiumId, 'mineral'),
                    ball: this.getProductValues(stadiumId, 'ball')
                };
                const productCost = Object.values(products).reduce((sum, p) => sum + (p.qty * p.price), 0);
                
                return {
                    time: this.formatTime(timeDiff),
                    stadiumCost,
                    productCost,
                    totalCost: stadiumCost + productCost
                };
            }

            async sendToGoogleSheets(data) {
                const payload = {
                    stadiumId: data.stadiumId,
                    startTime: data.startTime,
                    endTime: data.endTime,
                    waterQty: data.waterQty || 0,
                    waterPrice: data.waterPrice || 0,
                    mineralQty: data.mineralQty || 0,
                    mineralPrice: data.mineralPrice || 0,
                    ballQty: data.ballQty || 0,
                    ballPrice: data.ballPrice || 0,
                    totalCost: data.totalCost || 0
                };

                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                } catch (error) {
                    throw new Error(`L·ªói k·∫øt n·ªëi: ${error.message}`);
                }
            }

            async updateServerStatus(stadiumId, status) {
                try {
                    const payload = {
                        action: "updateStatus",
                        stadiumId: stadiumId,
                        status: status.toUpperCase()
                    };

                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                } catch (error) {
                    this.showNotification(`‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ${error.message}`, 'error');
                }
            }

            getProductValues(stadiumId, prefix) {
                return {
                    qty: this.getInputValue(stadiumId, `.${prefix}-quantity`),
                    price: this.getInputValue(stadiumId, `.${prefix}-price`)
                };
            }

            updateUI(stadiumId, status) {
                const stadium = this.getStadiumElement(stadiumId);
                stadium.querySelector('.start-btn').style.display = status === 'busy' ? 'none' : 'block';
                stadium.querySelector('.calculate-btn').style.display = status === 'busy' ? 'block' : 'none';
                stadium.querySelector('.status-indicator').className = `status-indicator status-${status}`;
                stadium.querySelector('.status-indicator').textContent = status === 'busy' ? 'üî¥ ƒêang s·ª≠ d·ª•ng' : 'üü¢ Tr·ªëng';
                if(status === 'available') stadium.querySelector('.time-display').textContent = 'üïí 00:00:00';
            }

            startTimer(stadiumId, startTime) {
                const timerElement = this.getStadiumElement(stadiumId).querySelector('.time-display');
                const update = () => {
                    const diff = new Date() - startTime;
                    timerElement.textContent = `üïí ${this.formatTime(diff)}`;
                };
                update();
                this.timers[stadiumId] = setInterval(update, 1000);
            }

            restoreSessions() {
                this.stadiums.forEach(stadium => {
                    const session = localStorage.getItem(`stadium_${stadium.id}`);
                    if (session && JSON.parse(session).status === 'busy') {
                        this.startTimer(stadium.id, new Date(JSON.parse(session).startTime));
                        this.updateUI(stadium.id, 'busy');
                    }
                });
            }

            getStadiumElement(stadiumId) {
                return document.querySelector(`[data-stadium-id="${stadiumId}"]`);
            }

            getInputValue(stadiumId, selector) {
                return parseInt(this.getStadiumElement(stadiumId).querySelector(selector).value) || 0;
            }

            getProductData(stadiumId) {
                return {
                    waterQty: this.getInputValue(stadiumId, '.water-quantity'),
                    waterPrice: this.getInputValue(stadiumId, '.water-price'),
                    mineralQty: this.getInputValue(stadiumId, '.mineral-quantity'),
                    mineralPrice: this.getInputValue(stadiumId, '.mineral-price'),
                    ballQty: this.getInputValue(stadiumId, '.ball-quantity'),
                    ballPrice: this.getInputValue(stadiumId, '.ball-price')
                };
            }

            formatTime(ms) {
                const pad = n => n.toString().padStart(2, '0');
                const h = Math.floor(ms / 3600000);
                const m = Math.floor((ms % 3600000) / 60000);
                const s = Math.floor((ms % 60000) / 1000);
                return `${pad(h)}:${pad(m)}:${pad(s)}`;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            }

            displayResult(stadiumId, data) {
                const resultDiv = this.getStadiumElement(stadiumId).querySelector('.result-box');
                resultDiv.innerHTML = `
                    <div>‚è± Th·ªùi gian: ${data.time}</div>
                    <div>üèü Ti·ªÅn s√¢n: ${this.formatCurrency(data.stadiumCost)}</div>
                    <div>üõí Ph·ª• ph√≠: ${this.formatCurrency(data.productCost)}</div>
                    <div style="margin-top:15px;font-weight:bold;color:var(--primary-color);">
                        üíµ T·ªïng c·ªông: ${this.formatCurrency(data.totalCost)}
                    </div>
                `;
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `global-notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        }

        new StadiumManager(STADIUMS);
    </script>
</body>
</html>
